---
title: "Reading Bruker OPUS binary files in R"
author: "Philipp Baumann and Thomas Knecht"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Reading Bruker OPUS binary files in R}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 80
---

```{r setup, include=FALSE, echo=TRUE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  results = "markup",
  include = TRUE
)
```

# Motivation

Spectrometers from Bruker速 Optics GmbH & Co. KG save spectra in a binary file
format known as OPUS. Each OPUS file corresponds to one sample measurement,
typically acquired through the OPUS spectroscopy software. These files have
numerical extensions, with incrementing extension numbers based on the naming
scheme chosen in the OPUS software.

The OPUS suite and the file specification are proprietary, leading to the need
for an implementation based on reverse engineering in this package. With
{opusreader2}, you can access your spectroscopic data in the open computing
language R, providing full control over your data analytics pipeline. Our
package specifically reads binary files for most Fourier-Transform Infrared
(FT-IR) spectrometers from Bruker Optics GmbH. While it may work for other
products like Raman spectrometers, further adjustments are required to support
new data types (see below).

# OPUS data extraction

The processing of each OPUS file begins by extracting essential information from
a designated byte range in the file header. This section contains crucial
details about binary blocks (also called chunks), including byte offsets, sizes,
and data types within the file. The parsing algorithm utilizes this information
to extract modular blocks of data and parameters from byte sequences. As
illustrated in the figure below, the content of the files varies based on the
instrument type, user-selected data (spectrum) blocks to save, and specific
settings.

![OPUS measurement settings for Bruker INVENIO速 fourier-transform (FT)
mid-infrared
spectrometer](images/opus-measurement-settings.png){#fig:opus_settings}

In addition to result spectra, the binary files encompass:

-   a comprehensive set of measurement parameters (configurations, conditions)

-   single-channel data from background measurements done before the sample

-   other types of intermediate spectra. Currently, we support *data blocks to
    be saved* for fourier-transform infrared spectrometers.

## Reading and parsing OPUS files in R

With `read_opus()` you can either read single or multiple OPUS files. Let's take
an example file produced by a Bruker ALPHA速 spectrometer that operates in
diffuse-reflectance mid-infrared mode. The spectral measurement of a soil sample
comes with the package and is also part of the data set in Baumann et al.
(2020). Here is how OPUS software represents parsed blocks in the OPUS viewer
software from Bruker速.

![Data parameters for absorbance (AB) spectrum](images/OPUS_block1.png)

We can extract all those blocks from the corresponding OPUS file example. We can
even read more blocks that are not displayed visually in the official software
but are present in the file.

```{r}
library("opusreader2")
# example file
file_1 <- system.file("extdata", "test_data", "BF_lo_01_soil_cal.1",
  package = "opusreader2"
)
spectrum_1 <- read_opus(dsn = file_1)
```

The `dsn` argument provides is the data source name, that currently either be a
character vector of the folder path to read files from recursively, or
characters of OPUS file paths.

**`read_opus()`** returns a nested list of class `"list_opusreader2"`. At the
first level of the list output, data is arranged as shown in the Bruker OPUS
viewer.

```{r}
class(spectrum_1)
```

For examining parsed lists in RStudio, we also recommend to use the "list
preview" via `View(spectrum_1)`, that you can also access in the "Environment"
tab. Here we use base R subsetting, `names()` and `str` to browse the example
data.

```{r}
names(spectrum_1)
data_1 <- spectrum_1[["BF_lo_01_soil_cal.1"]]
names(data_1)
```

We can for example verify the frequency of the first point (FXV). All types of
data and parameters within OPUS files are encoded with three capital letters
each.

```{r}
data_1$ab_data_param$parameters$FXV$parameter_value
```

Besides the data or parameter values, the output of each parsed OPUS block
contains the block type, channel type, text type, additional type, the offset in
bytes, next offset in bytes, and the chunk size in bytes for particular data
blocks. This is decoded from the file header and allows for traceability in the
parsing process.

```{r}
class(data_1$ab_data_param)
str(data_1$ab_data_param)
```

```{r}
str(data_1$instrument)
```

For single OPUS files, there `read_opus_single()` implementation can also be
used

```{r}
data_single <- read_opus_single(dsn = file_1)
```
